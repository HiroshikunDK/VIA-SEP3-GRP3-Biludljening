@page "/payment/{bookingId:int}"
@using System.Text.Json
@using CarApp.Services.Payment
@using Microsoft.AspNetCore.Components.Authorization
@using Shared.Dto
@using Shared.Dto.Payment
@inject IPaymentService PaymentService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Payment</h3>

<EditForm Model="payment" OnValidSubmit="SubmitPayment">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label>Credit Card Number:</label>
        <InputText @bind-Value="creditCardNumber" />
    </div>
    <div>
        <label>Expiration Date (MM/YY):</label>
        <InputText @bind-Value="expirationDate" />
    </div>
    <button type="submit">Pay</button>
</EditForm>

@code {
    [Parameter] public int BookingId { get; set; }

    private PaymentDto payment = new();
    private string creditCardNumber;
    private string expirationDate;

    private async Task SubmitPayment()
    {
        payment.BookingId = BookingId;
        payment.Status = "Pending";

        // Validate and sanitize credit card number
        string sanitizedCreditCardNumber = creditCardNumber.Replace(" ", "").Trim();
        if (!int.TryParse(sanitizedCreditCardNumber, out int creditCardRef))
        {
            Console.WriteLine("Invalid credit card number.");
            return;
        }
        payment.CreditCardRef = creditCardRef;

        // Add additional fields
        payment.CustomerId = await GetCurrentCustomerIdAsync();
        payment.ExpirationDate = expirationDate;

        try
        {
            Console.WriteLine($"Submitting Payment: {JsonSerializer.Serialize(payment)}");
            var response = await PaymentService.CreatePaymentAsync(payment);
            Console.WriteLine($"Response received: {JsonSerializer.Serialize(response)}");

            if (response?.PaymentId > 0)
            {
                Console.WriteLine($"Navigation to confirmation: bookingId={BookingId}, paymentId={response.PaymentId}");
                NavigationManager.NavigateTo($"/confirmation?bookingId={BookingId}&paymentId={response.PaymentId}");
            }
            else
            {
                Console.WriteLine("Payment creation failed or invalid PaymentId.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing payment: {ex.Message}");
        }
    }



    private async Task<int> GetCurrentCustomerIdAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var customerIdClaim = user.FindFirst("id");
            if (customerIdClaim != null && int.TryParse(customerIdClaim.Value, out int customerId))
            {
                return customerId;
            }
        }

        throw new InvalidOperationException("Unable to retrieve CustomerId from claims.");
    }
}
