@page "/payment/{bookingId:int}"
@using CarApp.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Shared.Dto
@inject IPaymentService PaymentService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Payment</h3>

<EditForm Model="payment" OnValidSubmit="SubmitPayment">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label>Credit Card Number:</label>
        <InputText @bind-Value="creditCardNumber" />
    </div>
    <div>
        <label>Expiration Date (MM/YY):</label>
        <InputText @bind-Value="expirationDate" />
    </div>
    <button type="submit">Pay</button>
</EditForm>

@code {
    [Parameter] public int BookingId { get; set; }

    private PaymentDto payment = new();
    private string creditCardNumber;
    private string expirationDate;

    private async Task SubmitPayment()
    {
        payment.BookingId = BookingId;
        payment.Status = "Pending";

        // Validate and sanitize credit card number
        string sanitizedCreditCardNumber = creditCardNumber.Replace(" ", "").Trim();
        if (!int.TryParse(sanitizedCreditCardNumber, out int creditCardRef))
        {
            Console.WriteLine("Invalid credit card number.");
            return;
        }
        payment.CreditCardRef = creditCardRef;

        // Add additional fields
        payment.CustomerId = await GetCurrentCustomerIdAsync();
        payment.ExpirationDate = expirationDate;

        try
        {
            var response = await PaymentService.CreatePaymentAsync(payment);
            if (response?.Id > 0) 
            {
                NavigationManager.NavigateTo($"/confirmation?bookingId={BookingId}&paymentId={response.Id}");
            }
            else
            {
                Console.WriteLine("Payment creation failed.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing payment: {ex.Message}");
        }
    }


    private async Task<int> GetCurrentCustomerIdAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            var customerIdClaim = user.FindFirst("id");
            if (customerIdClaim != null && int.TryParse(customerIdClaim.Value, out int customerId))
            {
                return customerId;
            }
        }

        throw new InvalidOperationException("Unable to retrieve CustomerId from claims.");
    }
}
